import pandas as pd

df = pd.read_csv('SraRunTable_lemons_test.txt', sep=',', header=0)

# append all accession number to a list
ACCESSIONS = []

for i in df['Run']:
    ACCESSIONS.append(i)

rule all:
    input: 
        expand("fastq_lemons_test/{accession}.fastq.gz", accession=ACCESSIONS),
        expand("trimmed_lemons_test/{accession}.fastq.gz", accession=ACCESSIONS),
        expand("fastq_lemons_test/qc/{accession}_fastqc.html", accession=ACCESSIONS),
        expand("trimmed_lemons_test/qc/{accession}_fastqc.html", accession=ACCESSIONS),
        "reports_test/multiqc_report_lemons_test.html"

rule fetch_fastq:
    output: 
        expand("fastq_lemons_test/{accession}.fastq.gz", accession=ACCESSIONS)
    params:
        accession=ACCESSIONS,
        outdir="fastq_lemons_test"
    shell:
        "parallel-fastq-dump --sra-id {params.accession} --threads 16 --outdir {params.outdir} --gzip"

rule fastq_qc:
    input:
        "fastq_lemons_test/{accession}.fastq.gz"
    output:
        html="fastq_lemons_test/qc/{accession}_fastqc.html",
        zip="fastq_lemons_test/qc/{accession}_fastqc.zip"
    params:
        outdir="fastq_lemons_test/qc"
    shell:
        "fastqc -t 16 {input} -o {params.outdir}"

rule trim_filter:
    input:
        "fastq_lemons_test/{name}.fastq.gz"
    output:
        "trimmed_lemons_test/{name}.fastq.gz"
    shell:
        "cutadapt -j 16 -m 20 --cut 10 -o {output} {input}"

rule trim_qc:
    input:
        "trimmed_lemons_test/{accession}.fastq.gz"
    output:
        html="trimmed_lemons_test/qc/{accession}_fastqc.html",
        zip="trimmed_lemons_test/qc/{accession}_fastqc.zip",
    params:
        outdir="trimmed_lemons_test/qc"
    shell:
        "fastqc -t 16 {input} -o {params.outdir}"

rule report:
    params:
        rules.fastq_qc.params.outdir,
        rules.trim_qc.params.outdir
    output:
        "reports_test/multiqc_report_lemons_test.html"
    shell:
        "multiqc --force -d {params} -n {output}"
